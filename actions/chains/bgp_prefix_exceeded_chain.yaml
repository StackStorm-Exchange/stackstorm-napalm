---
    chain:
        -
            name: "show_bgp_neighbours"
            ref: "napalm.get_bgp_neighbors"
            parameters:
                hostname: "{{ hostname }}"
                credentials: "public"
            publish:
              neighbourdetails: "{{ show_bgp_neighbours.result.global.peers.get(neighbour) }}"
              stderr: "{{ show_bgp_neighbours.stderr }}"
            on-success: "show_route"
            on-failure: "report_failure"
        -
            name: "show_route"
            ref: "napalm.routeto"
            parameters:
                hostname: "{{ hostname }}"
                destination: "{{ neighbour }}"
                credentials: "public"
            publish:
              stderr: "{{ show_route.stderr }}"
            on-success: "send_email"
            on-failure: "report_failure"
        -
            name: "send_email"
            ref: "core.sendmail"
            parameters:
              to: "rob.woodward@colt.net"
              from: "stackstorm@colt.net"
              subject: "BGP neighbour <% $.neighbour %> exceeded prefix limit on <% $.hostname %>."
              body:  "{{ message }}\r\n
                      {{ neighbourdetails | to_json_string }}
                      {{ show_route.result | to_json_string }}"
        -
            name: "report_failure"
            ref: "core.sendmail"
            parameters:
              to: "rob.woodward@colt.net"
              from: "stackstorm@colt.net"
              subject: "Stackstorm BGP prefix exceeded workflow error"
              body:  "Something went wrong with the BGP neighbour prefix exceeded workflow.\r\n\r\n {{ stderr }}"
    default: "show_bgp_neighbours"
