---
  chain:
      -
        name: "show_bgp_neighbours"
        ref: "napalm.get_bgp_neighbors"
        parameters:
          hostname: "{{ hostname }}"
          host_ip: "{{ host_ip }}"
          neighbour: "{{ neighbour }}"
        on-success: "show_route"
        on-failure: "report_failure"
      -
        name: "show_route"
        ref: "napalm.get_route_to"
        parameters:
          hostname: "{{ hostname }}"
          host_ip: "{{ host_ip }}"
          destination: "{{ neighbour }}"
        on-success: "show_log"
        on-failure: "report_failure"
      -
        name: "show_log"
        ref: "napalm.get_log"
        parameters:
          hostname: "{{ hostname }}"
          host_ip: "{{ host_ip }}"
          lastlines: 10
        on-success: "send_email"
        on-failure: "report_failure"
      -
        name: "send_email"
        ref: "core.sendmail"
        parameters:
          to: "{{st2kv.system.napalm_bgpsyslog_mailto}}"
          from: "{{st2kv.system.napalm_bgpsyslog_mailfrom}}"
          subject: "BGP neighbour {{ neighbour }} AS{{ asnum }} exceeded prefix limit on {{ hostname }}."
          content_type: "text/plain"
          body: "{{ message }}\r\n\r\n
                {% for key, value in show_bgp_neighbours.result.iteritems() %}
                  {% if key is equalto 'address_family' %}
                    {% for keyaf, valueaf in value.iteritems() %}
                      {% if keyaf is equalto 'ipv4' %}
                        \r\nAddress Family (IPv4):
                        {% for keyv4, valuev4 in valueaf.iteritems() %}
                          \r\n{{ keyv4 }} : {{ valuev4 }}
                        {% endfor %}
                      {% elif keyaf is equalto 'ipv6' %}
                        \r\nAddress Family (IPv6):
                        {% for keyv6, valuev6 in valueaf.iteritems() %}
                          \r\n{{ keyv6 }} : {{ valuev6 }}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    \r\n{{ key }} : {{ value }}
                  {% endif %}
                {% endfor %}

                \r\nRoute to neighbour is:\r\n\r\n
                {{ show_route.result | to_json_string }}\r\n\r\n

                \r\nLog file from Device:\r\n\r\n
                {% for log_line in show_log.result %}
                  \r\n{{ log_line }}
                {% endfor %}
                \r\n\r\n"
      -
        name: "report_failure"
        ref: "core.sendmail"
        parameters:
          to: "{{st2kv.system.napalm_actionerror_mailto}}"
          from: "{{st2kv.system.napalm_actionerror_mailfrom}}"
          subject: "Stackstorm BGP prefix exceeded workflow error"
          body:  "Something went wrong with the device backup workflow. Check stackstorm for the error. Execution ID: {{action_context.parent.execution_id}}.\r\n\r\n"
  default: "show_bgp_neighbours"
